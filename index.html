<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Lucy Walker Jewelry - Client Portal</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    :root {
      --primary: #1B3A52;
      --primary-light: #2a5578;
      --accent: #D64C00;
      --accent-light: #e8622a;
      --background: #f9fafb;
      --surface: #ffffff;
      --text: #111827;
      --text-muted: #6b7280;
      --border: #e5e7eb;
      --green: #16a34a;
      --green-bg: #f0fdf4;
      --red: #dc2626;
      --red-bg: #fef2f2;
      --yellow: #ca8a04;
      --yellow-bg: #fefce8;
      --blue: #2563eb;
    }

    body {
      font-family: 'Space Grotesk', sans-serif;
      background: var(--background);
      color: var(--text);
      line-height: 1.5;
    }

    .header {
      background: var(--primary);
      padding: 20px 32px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .header-left { display: flex; align-items: center; gap: 16px; }
    .logo { font-size: 22px; font-weight: 700; color: #ffffff; letter-spacing: -0.5px; }
    .logo-accent { color: var(--accent); }
    .badge { background: rgba(255,255,255,0.15); color: rgba(255,255,255,0.9); font-size: 11px; font-weight: 600; padding: 4px 10px; text-transform: uppercase; letter-spacing: 0.5px; }
    .header-right { display: flex; align-items: center; gap: 24px; }
    .nav { display: flex; gap: 24px; }
    .nav a { text-decoration: none; color: rgba(255,255,255,0.6); font-size: 14px; font-weight: 500; transition: color 0.2s; cursor: pointer; }
    .nav a:hover, .nav a.active { color: #ffffff; }
    .nav a.active { border-bottom: 2px solid var(--accent); padding-bottom: 2px; }
    .updated { font-size: 13px; color: rgba(255,255,255,0.6); }

    .container { max-width: 1400px; margin: 0 auto; padding: 24px 32px; }

    .title-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; }
    .page-title { font-size: 20px; font-weight: 700; color: var(--primary); }
    .date-range { display: flex; gap: 8px; }
    .date-btn { padding: 6px 14px; border: 2px solid var(--border); background: var(--surface); font-family: 'Space Grotesk', sans-serif; font-size: 13px; font-weight: 500; cursor: pointer; color: var(--text-muted); transition: all 0.2s; }
    .date-btn:hover { border-color: var(--primary); color: var(--primary); }
    .date-btn.active { background: var(--primary); border-color: var(--primary); color: #ffffff; }

    .bento-grid { display: grid; grid-template-columns: repeat(12, 1fr); gap: 16px; }
    .block { background: var(--surface); border: 2px solid var(--border); padding: 24px; }

    /* KPI Cards */
    .kpi-card { grid-column: span 2; position: relative; border-left: 4px solid var(--border); }
    .kpi-card.primary { border-left-color: var(--primary); }
    .kpi-card.accent { border-left-color: var(--accent); }
    .kpi-card.green { border-left-color: var(--green); }
    .kpi-label { font-size: 11px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; color: var(--text-muted); margin-bottom: 8px; }
    .kpi-source { font-size: 10px; font-weight: 500; text-transform: uppercase; letter-spacing: 0.4px; color: var(--text-muted); opacity: 0.7; margin-bottom: 4px; }
    .kpi-value { font-size: 28px; font-weight: 700; color: var(--primary); line-height: 1; margin-bottom: 8px; }
    .kpi-change { font-size: 13px; font-weight: 600; display: flex; align-items: center; gap: 4px; }
    .kpi-change.positive { color: var(--green); }
    .kpi-change.negative { color: var(--red); }
    .kpi-change.neutral { color: var(--text-muted); }
    .kpi-sub { font-size: 12px; color: var(--text-muted); margin-top: 4px; }

    /* Funnel */
    .funnel-block { grid-column: span 7; }
    .block-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
    .block-title { font-size: 13px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; color: var(--text); }
    .funnel-viz { display: flex; flex-direction: column; gap: 8px; padding: 8px 0; }
    .funnel-stage { display: flex; align-items: center; gap: 12px; }
    .funnel-label { font-size: 12px; font-weight: 600; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.4px; width: 110px; flex-shrink: 0; text-align: right; }
    .funnel-bar-wrap { flex: 1; position: relative; height: 36px; display: flex; align-items: center; }
    .funnel-bar { height: 100%; display: flex; align-items: center; padding-left: 12px; font-size: 13px; font-weight: 700; color: #fff; transition: width 0.6s ease; min-width: 60px; }
    .funnel-bar.ga4 { background: #2563eb; }
    .funnel-bar.mp { background: var(--accent); }
    .funnel-bar.mp-active { background: var(--green); }
    .funnel-dropoff { font-size: 11px; color: var(--text-muted); margin-left: 8px; font-weight: 500; white-space: nowrap; }
    .funnel-source-tag { font-size: 10px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.4px; padding: 2px 6px; background: var(--background); color: var(--text-muted); border: 1px solid var(--border); white-space: nowrap; flex-shrink: 0; }

    /* Insights */
    .insights-block { grid-column: span 5; }
    .insight { padding: 14px 16px; border-left: 3px solid var(--accent); background: #fffbf7; margin-bottom: 12px; font-size: 13px; line-height: 1.6; color: var(--text); }
    .insight:last-child { margin-bottom: 0; }
    .insight-icon { margin-right: 6px; }
    .insight strong { color: var(--primary); }

    /* Tables */
    .table-block { grid-column: span 7; }
    .plans-block { grid-column: span 5; }
    .full-block { grid-column: span 12; }
    .half-block { grid-column: span 6; }
    .data-table { width: 100%; border-collapse: collapse; font-size: 14px; }
    .data-table thead th { text-align: left; font-size: 11px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; color: var(--text-muted); padding: 12px 16px; border-bottom: 2px solid var(--border); white-space: nowrap; }
    .data-table thead th.right { text-align: right; }
    .data-table tbody td { padding: 14px 16px; border-bottom: 1px solid var(--border); vertical-align: middle; }
    .data-table tbody td.right { text-align: right; font-variant-numeric: tabular-nums; }
    .data-table tbody tr:last-child td { border-bottom: none; }
    .data-table tbody tr:hover { background: #f9fafb; }
    .source-name { font-weight: 600; color: var(--primary); }
    .source-badge { display: inline-block; font-size: 10px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.4px; padding: 2px 6px; margin-left: 8px; }
    .badge-paid { background: #eef2ff; color: #4338ca; }
    .badge-organic { background: #f0fdf4; color: #16a34a; }
    .badge-email { background: #fff7ed; color: #c2410c; }
    .badge-direct { background: #f8fafc; color: #64748b; }
    .badge-referral { background: #fdf4ff; color: #9333ea; }
    .badge-social { background: #eff6ff; color: #2563eb; }
    .conv-bar { display: flex; align-items: center; gap: 8px; }
    .conv-fill { height: 6px; background: var(--accent); min-width: 4px; }
    .conv-value { font-weight: 600; font-size: 14px; white-space: nowrap; }
    .data-table tbody tr.summary-row td { font-weight: 700; border-top: 2px solid var(--primary); border-bottom: none; background: #f8fafc; }

    .source-dot { display: inline-block; width: 8px; height: 8px; border-radius: 50%; margin-right: 6px; vertical-align: middle; }
    .dot-ga4 { background: #2563eb; }
    .dot-mp { background: var(--accent); }
    .dot-active { background: var(--green); }

    /* Status pills */
    .status-pill { display: inline-block; font-size: 11px; font-weight: 600; padding: 2px 8px; text-transform: uppercase; letter-spacing: 0.3px; }
    .status-active { background: var(--green-bg); color: var(--green); }
    .status-cancelled { background: var(--red-bg); color: var(--red); }
    .status-pending { background: var(--yellow-bg); color: var(--yellow); }
    .status-suspended { background: #f3f4f6; color: #6b7280; }

    /* Charts (CSS bar charts) */
    .bar-chart-wrap { overflow: hidden; }
    .bar-chart { display: flex; align-items: flex-end; gap: 3px; height: 160px; }
    .bar-col { flex: 1; min-width: 4px; border-radius: 2px 2px 0 0; transition: height 0.4s ease; cursor: default; }
    .bar-col:hover { opacity: 0.8; }
    .bar-signups { background: var(--accent); }
    .bar-sessions { background: var(--blue); }
    .bar-chart-labels { display: flex; gap: 3px; margin-top: 6px; }
    .bar-label-col { flex: 1; min-width: 4px; display: flex; justify-content: center; overflow: visible; }
    .bar-label { font-size: 9px; color: var(--text-muted); white-space: nowrap; transform: rotate(-45deg); transform-origin: top center; display: block; }
    .bar-label-hidden { visibility: hidden; }
    .chart-legend { display: flex; gap: 16px; font-size: 12px; color: var(--text-muted); margin-top: 12px; }
    .legend-dot { display: inline-block; width: 10px; height: 10px; margin-right: 4px; vertical-align: middle; }

    /* Stat cards */
    .stat-row { display: flex; gap: 16px; margin-bottom: 16px; }
    .stat-item { flex: 1; padding: 16px; background: var(--background); border: 1px solid var(--border); }
    .stat-label { font-size: 11px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; color: var(--text-muted); margin-bottom: 4px; }
    .stat-value { font-size: 24px; font-weight: 700; color: var(--primary); }
    .stat-sub { font-size: 12px; color: var(--text-muted); margin-top: 2px; }

    .loading { text-align: center; padding: 60px; color: var(--text-muted); font-size: 14px; }

    /* Break-even meter */
    .meter-block { grid-column: span 12; }
    .meter-wrap { margin-top: 8px; }
    .meter-label-row { display: flex; justify-content: space-between; font-size: 12px; color: var(--text-muted); margin-bottom: 8px; font-weight: 500; }
    .meter-track { position: relative; height: 28px; background: #f3f4f6; border: 1px solid var(--border); overflow: visible; }
    .meter-fill { height: 100%; display: flex; align-items: center; padding-left: 10px; font-size: 12px; font-weight: 700; color: #fff; transition: width 0.6s ease; min-width: 60px; }
    .meter-fill.roi-positive { background: var(--green); }
    .meter-fill.roi-neutral { background: var(--yellow); }
    .meter-fill.roi-negative { background: var(--red); }
    .meter-fill.roi-unknown { background: var(--text-muted); }
    .meter-breakeven { position: absolute; top: -6px; bottom: -6px; width: 2px; background: var(--primary); }
    .meter-breakeven-label { position: absolute; top: -20px; left: 50%; transform: translateX(-50%); font-size: 10px; font-weight: 600; color: var(--primary); white-space: nowrap; }
    .meter-status-row { display: flex; align-items: center; gap: 10px; margin-top: 12px; }
    .roi-badge { display: inline-block; padding: 4px 12px; font-size: 12px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; }
    .roi-badge.positive { background: var(--green-bg); color: var(--green); }
    .roi-badge.neutral { background: var(--yellow-bg); color: var(--yellow); }
    .roi-badge.negative { background: var(--red-bg); color: var(--red); }
    .roi-badge.unknown { background: #f3f4f6; color: var(--text-muted); }
    .roi-note { font-size: 12px; color: var(--text-muted); }

    /* Cohort table */
    .cohort-week { font-size: 13px; font-weight: 600; color: var(--primary); }
    .cohort-dash { color: var(--text-muted); font-size: 13px; }
    .cohort-converted { color: var(--green); font-weight: 700; }
    .cohort-cancelled { color: var(--red); font-weight: 700; }
    .cohort-in-trial { color: var(--blue); font-weight: 700; }

    /* Trial ROI â€” Status Banner */
    .roi-status-banner { display: flex; justify-content: space-between; align-items: center; gap: 16px; }
    .roi-status-banner.negative { background: var(--red-bg); border-color: var(--red); }
    .roi-status-banner.positive { background: var(--green-bg); border-color: var(--green); }
    .roi-status-banner.neutral { background: var(--yellow-bg); border-color: var(--yellow); }
    .roi-status-main { font-size: 15px; font-weight: 700; }
    .roi-status-detail { font-size: 13px; color: var(--text-muted); margin-top: 3px; }

    /* Trial ROI â€” Pipeline Funnel */
    .pipeline-stages { display: flex; align-items: stretch; margin-top: 12px; }
    .pipeline-step { flex: 1; padding: 16px 12px; background: var(--background); border: 2px solid var(--border); min-width: 0; }
    .pipeline-step-label { font-size: 10px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; color: var(--text-muted); margin-bottom: 8px; }
    .pipeline-step-value { font-size: 22px; font-weight: 700; line-height: 1.1; margin-bottom: 4px; }
    .pipeline-step-sub { font-size: 11px; color: var(--text-muted); }
    .pipeline-conv { font-size: 11px; font-weight: 600; margin-top: 6px; padding: 2px 6px; display: inline-block; }
    .pipeline-conv.good { color: var(--green); background: var(--green-bg); }
    .pipeline-conv.poor { color: var(--red); background: var(--red-bg); }
    .pipeline-conv.neutral { color: var(--blue); background: #eff6ff; }
    .pipeline-arrow { display: flex; align-items: center; justify-content: center; width: 28px; flex-shrink: 0; font-size: 16px; color: var(--border); }
    .pipeline-offer-note { margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--border); font-size: 12px; color: var(--text-muted); line-height: 1.6; }

    /* Trial ROI â€” AI Insights */
    .insights-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap: 12px; }
    .insight.good { border-left-color: var(--green); background: var(--green-bg); }
    .insight.warn { border-left-color: var(--red); background: var(--red-bg); }
    .insight.info { border-left-color: var(--blue); background: #eff6ff; }
    .insight-title { font-size: 13px; font-weight: 700; color: var(--primary); margin-bottom: 5px; }
    .insight-body { font-size: 12px; color: var(--text); line-height: 1.55; }
    .insight-action { font-size: 12px; font-style: italic; color: var(--text-muted); margin-top: 8px; padding-top: 8px; border-top: 1px solid rgba(0,0,0,0.07); line-height: 1.55; }

    .portal-footer { margin-top: 32px; padding: 24px 0; border-top: 2px solid var(--border); display: flex; justify-content: space-between; align-items: center; font-size: 13px; color: var(--text-muted); }
    .footer-brand { font-weight: 600; color: var(--primary); }
    .data-sources { display: flex; gap: 16px; align-items: center; }
    .data-source-tag { font-size: 11px; font-weight: 600; padding: 3px 8px; border: 1px solid var(--border); color: var(--text-muted); }

    /* Tab content visibility */
    .tab-content { display: none; }
    .tab-content.active { display: block; }

    @media (max-width: 1024px) {
      .kpi-card { grid-column: span 4; }
      .funnel-block, .insights-block, .table-block, .plans-block, .half-block { grid-column: span 12; }
    }
    @media (max-width: 768px) {
      .kpi-card { grid-column: span 6; }
      .header { padding: 14px 16px; gap: 10px; }
      .header-left { gap: 10px; }
      .header-right { width: 100%; justify-content: space-between; }
      .nav { gap: 16px; }
      .updated { font-size: 12px; }
      .logo { font-size: 18px; }
      .container { padding: 12px 12px; }
      .title-bar { flex-direction: column; gap: 10px; align-items: flex-start; margin-bottom: 16px; }
      .bento-grid { gap: 10px; }
      .block { padding: 14px 12px; }
      .funnel-label { font-size: 10px; width: 80px; }
      .funnel-bar { font-size: 11px; min-width: 40px; }
      .funnel-source-tag { display: none; }
      .source-badge { display: none; }
      /* Tables â€” compact and full width, no scroll */
      .data-table { font-size: 11px; width: 100%; table-layout: fixed; }
      .data-table thead th, .data-table tbody td { padding: 8px 6px; }
      .data-table thead th:first-child, .data-table tbody td:first-child { width: 38%; }
      /* Hide % of Active column on mobile */
      .hide-mobile { display: none !important; }
      /* Conv bar â€” just show the number, hide the bar */
      .conv-fill { display: none; }
      .conv-value { font-size: 11px; }
      .portal-footer { flex-direction: column; gap: 10px; align-items: flex-start; }
      /* Stat row: 2-column grid */
      .stat-row { flex-wrap: wrap; }
      .stat-item { flex: 1 1 calc(50% - 8px); min-width: 0; }
      .stat-value { font-size: 20px; }
    }
    @media (max-width: 480px) {
      .kpi-card { grid-column: span 6; }
      .kpi-value { font-size: 22px; }
      .header { flex-direction: column; align-items: flex-start; gap: 8px; }
      .block { padding: 14px; }
      .insight { font-size: 12px; padding: 10px 12px; }
      .page-title { font-size: 17px; }
      .nav { gap: 12px; }
    }
    @media (max-width: 360px) {
      .kpi-card { grid-column: span 12; }
      .kpi-value { font-size: 26px; }
    }

    @media print {
      * { -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }
      body { background: white; font-size: 10px; }
      .header { background: var(--primary) !important; padding: 12px 20px; }
      .logo { font-size: 16px; }
      .nav, .date-range { display: none; }
      .bento-grid { gap: 8px; grid-template-columns: repeat(6, 1fr) !important; }
      .block { break-inside: avoid; padding: 10px 12px; border-width: 1px; }
      .kpi-card { grid-column: span 1 !important; }
      .kpi-value { font-size: 16px; }
      .funnel-block { grid-column: span 4 !important; }
      .insights-block { grid-column: span 2 !important; }
      .table-block, .plans-block { grid-column: span 3 !important; }
      .data-table { font-size: 10px; }
      .portal-footer { margin-top: 12px; padding: 10px 0; font-size: 9px; }
    }
  </style>
</head>
<body>
  <header class="header">
    <div class="header-left">
      <div class="logo">Lucy Walker <span class="logo-accent">Jewelry</span></div>
      <span class="badge">Client Portal</span>
    </div>
    <div class="header-right">
      <nav class="nav" id="main-nav">
        <a class="active" data-tab="overview">Overview</a>
        <a data-tab="memberships">Memberships</a>
        <a data-tab="analytics">Analytics</a>
        <a data-tab="trial-roi">Trial ROI</a>
      </nav>
      <div class="updated" id="last-updated">Loading...</div>
    </div>
  </header>

  <div class="container">
    <div class="title-bar">
      <h1 class="page-title" id="page-title">Membership &amp; Traffic Overview</h1>
      <div class="date-range" id="date-range">
        <button class="date-btn" data-period="7d">7 Days</button>
        <button class="date-btn active" data-period="30d">30 Days</button>
        <button class="date-btn" data-period="90d">90 Days</button>
        <button class="date-btn" data-period="ytd">YTD</button>
      </div>
    </div>

    <!-- OVERVIEW TAB -->
    <div class="tab-content active" id="tab-overview">
      <div class="bento-grid" id="overview-grid">
        <div class="loading" style="grid-column: span 12;">Loading dashboard data...</div>
      </div>
    </div>

    <!-- MEMBERSHIPS TAB -->
    <div class="tab-content" id="tab-memberships">
      <div class="bento-grid" id="memberships-grid">
        <div class="loading" style="grid-column: span 12;">Loading membership data...</div>
      </div>
    </div>

    <!-- ANALYTICS TAB -->
    <div class="tab-content" id="tab-analytics">
      <div class="bento-grid" id="analytics-grid">
        <div class="loading" style="grid-column: span 12;">Loading analytics data...</div>
      </div>
    </div>

    <!-- TRIAL ROI TAB -->
    <div class="tab-content" id="tab-trial-roi">
      <div class="bento-grid" id="trial-roi-grid">
        <div class="loading" style="grid-column: span 12;">Loading trial ROI data...</div>
      </div>
    </div>

    <footer class="portal-footer">
      <div><span class="footer-brand">Lucy Walker Jewelry</span> &mdash; Client Portal</div>
      <div class="data-sources">
        <span class="data-source-tag">&#9679; MemberPress</span>
        <span class="data-source-tag">&#9679; GA4</span>
        <span class="data-source-tag">&#9679; Facebook Ads</span>
        <span>Data refreshed daily &bull; Powered by 8020agent</span>
      </div>
    </footer>
  </div>

  <script>
    // â”€â”€ STATE â”€â”€
    let DATA = null;
    let currentPeriod = '30d';
    let currentTab = 'overview';

    // â”€â”€ FORMATTERS â”€â”€
    function fmt$(n) {
      if (n >= 1000) return '$' + Math.round(n).toLocaleString();
      return '$' + n.toFixed(2);
    }
    function fmtNum(n) { return Math.round(n).toLocaleString(); }
    function fmtPct(n) { return n.toFixed(1) + '%'; }

    function changeHtml(pct, invert) {
      if (pct === 0) return '<span class="kpi-change neutral">&#8212; no change</span>';
      const positive = invert ? pct < 0 : pct > 0;
      const cls = positive ? 'positive' : 'negative';
      const arrow = pct > 0 ? '&#9650;' : '&#9660;';
      return `<span class="kpi-change ${cls}">${arrow} ${Math.abs(pct).toFixed(1)}% vs prev. period</span>`;
    }

    function sourceBadgeClass(source) {
      if (source.includes('Paid')) return 'badge-paid';
      if (source.includes('Organic')) return 'badge-organic';
      if (source.includes('Email')) return 'badge-email';
      if (source.includes('Social')) return 'badge-social';
      if (source.includes('Referral')) return 'badge-referral';
      return 'badge-direct';
    }

    function fmtDay(dateStr) {
      const d = new Date(dateStr + 'T00:00:00');
      return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
    }

    function periodLabel(key) {
      return { '7d': '7 Days', '30d': '30 Days', '90d': '90 Days', 'ytd': 'Year to Date' }[key] || key;
    }

    // â”€â”€ OVERVIEW TAB â”€â”€
    function renderOverview() {
      const period = DATA.periods[currentPeriod];
      const global = DATA.globalState;
      const { kpis, funnel, trafficSources, subscriptionBreakdown } = period;

      // KPI Cards
      const kpiCards = `
        <div class="block kpi-card green">
          <div class="kpi-source">MemberPress</div>
          <div class="kpi-label">Active Subscriptions</div>
          <div class="kpi-value">${fmtNum(kpis.totalActiveSubs)}</div>
          ${changeHtml(kpis.activeSubsChange, false)}
        </div>
        <div class="block kpi-card accent">
          <div class="kpi-source">MemberPress</div>
          <div class="kpi-label">Monthly Recurring</div>
          <div class="kpi-value">${fmt$(kpis.totalMrr)}</div>
          <div class="kpi-sub">${global.monthlySubs} monthly &bull; ${global.annualSubs} annual</div>
        </div>
        <div class="block kpi-card primary">
          <div class="kpi-source">MemberPress</div>
          <div class="kpi-label">New Signups</div>
          <div class="kpi-value">${fmtNum(kpis.newSignups)}</div>
          ${changeHtml(kpis.signupsChange, false)}
        </div>
        <div class="block kpi-card green">
          <div class="kpi-source">MemberPress</div>
          <div class="kpi-label">Retention Rate</div>
          <div class="kpi-value">${fmtPct(kpis.retentionRate)}</div>
          ${changeHtml(kpis.retentionChange, false)}
        </div>
        <div class="block kpi-card primary">
          <div class="kpi-source">GA4</div>
          <div class="kpi-label">Website Sessions</div>
          <div class="kpi-value">${fmtNum(kpis.websiteSessions)}</div>
          ${changeHtml(kpis.sessionsChange, false)}
        </div>
        <div class="block kpi-card accent">
          <div class="kpi-source">Calculated</div>
          <div class="kpi-label">Session &rarr; Signup</div>
          <div class="kpi-value">${fmtPct(kpis.conversionRate)}</div>
          <div class="kpi-sub">${fmtNum(kpis.churned)} cancelled this period</div>
        </div>`;

      // Funnel
      const maxFunnelValue = Math.max(...funnel.map(f => f.value), 1);
      const funnelColors = ['ga4', 'mp', 'mp-active'];
      const funnelTags = ['GA4', 'MemberPress', 'MemberPress'];
      const funnelStages = funnel.map((stage, i) => {
        const pct = Math.max(8, Math.round((stage.value / maxFunnelValue) * 100));
        const prev = funnel[i - 1];
        const dropoff = prev ? Math.round((1 - stage.value / prev.value) * 100) : null;
        const dropoffHtml = dropoff !== null && dropoff > 0
          ? `<span class="funnel-dropoff">&#9660; ${dropoff}% drop-off</span>` : '';
        return `
          <div class="funnel-stage">
            <div class="funnel-label">${stage.stage}</div>
            <div class="funnel-bar-wrap">
              <div class="funnel-bar ${funnelColors[i]}" style="width: ${pct}%;">${fmtNum(stage.value)}</div>
              ${dropoffHtml}
            </div>
            <div class="funnel-source-tag">${funnelTags[i]}</div>
          </div>`;
      }).join('');

      const funnelBlock = `
        <div class="block funnel-block">
          <div class="block-header">
            <div class="block-title">Conversion Funnel</div>
            <div style="display:flex;gap:12px;font-size:12px;color:var(--text-muted);">
              <span><span class="source-dot dot-ga4"></span>GA4</span>
              <span><span class="source-dot dot-mp"></span>Signups</span>
              <span><span class="source-dot dot-active"></span>Active</span>
            </div>
          </div>
          <div class="funnel-viz">${funnelStages}</div>
        </div>`;

      // Insights
      const insightLines = [
        `<div class="insight">
          <span class="insight-icon">&#128200;</span>
          <strong>${fmtPct(kpis.retentionRate)} of new signups remain active</strong> &mdash; ${subscriptionBreakdown.newActive} active out of ${kpis.newSignups} new signups.
          ${kpis.retentionRate >= 80
            ? 'Strong retention. The onboarding and value delivery is working well.'
            : 'Below 80% &mdash; review onboarding emails and first-week experience to reduce early churn.'}
        </div>`,
        `<div class="insight">
          <span class="insight-icon">&#128161;</span>
          <strong>${fmtPct(kpis.conversionRate)} of website visitors become members</strong> &mdash; ${fmtNum(kpis.newSignups)} signups from ${fmtNum(kpis.websiteSessions)} sessions.
          ${kpis.conversionRate >= 2
            ? 'Above the 2% benchmark for membership sites. Landing pages and CTAs are converting well.'
            : 'Below 2% &mdash; test pricing page copy, add testimonials, or improve the signup flow.'}
        </div>`,
        kpis.churned > 0 ? `<div class="insight">
          <span class="insight-icon">&#9888;</span>
          <strong>${fmtNum(kpis.churned)} cancellations this period</strong> &mdash; ${kpis.churnChange > 0 ? 'up' : 'down'} ${Math.abs(kpis.churnChange).toFixed(1)}% vs previous period.
          ${kpis.churned > kpis.newSignups * 0.15
            ? 'Cancellations are high relative to new signups. Consider a win-back email sequence or exit survey.'
            : 'Cancellation rate is manageable. Continue monitoring.'}
        </div>` : '',
        `<div class="insight">
          <span class="insight-icon">&#127919;</span>
          <strong>${fmtNum(kpis.totalActiveSubs)} active members generating ${fmt$(kpis.totalMrr)}</strong> in subscription value.
          The $47/month plan is the primary driver with ${global.monthlySubs} monthly and ${global.annualSubs} annual subscribers.
        </div>`,
      ].filter(Boolean).join('');

      const insightsBlock = `
        <div class="block insights-block">
          <div class="block-header"><div class="block-title">AI Insights</div></div>
          ${insightLines}
        </div>`;

      // Traffic Sources Table
      const totalSessions = trafficSources.reduce((s, r) => s + r.sessions, 0);
      const tableRows = trafficSources.map(row => {
        const pctOfTotal = totalSessions > 0 ? (row.sessions / totalSessions * 100) : 0;
        return `
          <tr>
            <td><span class="source-name">${row.source}</span></td>
            <td class="right">${fmtNum(row.sessions)}</td>
            <td class="right">${fmtPct(pctOfTotal)}</td>
          </tr>`;
      }).join('');

      const tableBlock = `
        <div class="block table-block">
          <div class="block-header"><div class="block-title">Traffic Sources (GA4)</div></div>
          <table class="data-table">
            <thead><tr><th>Source</th><th class="right">Sessions</th><th class="right">Share</th></tr></thead>
            <tbody>
              ${tableRows}
              <tr class="summary-row">
                <td><span class="source-name">All Sources</span></td>
                <td class="right">${fmtNum(totalSessions)}</td>
                <td class="right">100%</td>
              </tr>
            </tbody>
          </table>
        </div>`;

      // Plans Table
      const planRows = global.plans.map(p => {
        const label = p.periodType === 'months' ? fmt$(p.price) + '/mo' : fmt$(p.price) + '/yr';
        return `
          <tr>
            <td><span class="source-name">${label}</span></td>
            <td class="right">${fmtNum(p.activeCount)}</td>
            <td class="right">${fmt$(p.mrr)}</td>
          </tr>`;
      }).join('');

      const plansBlock = `
        <div class="block plans-block">
          <div class="block-header"><div class="block-title">Active Plans</div></div>
          <table class="data-table">
            <thead><tr><th>Plan</th><th class="right">Members</th><th class="right">Value</th></tr></thead>
            <tbody>${planRows}</tbody>
          </table>
        </div>`;

      document.getElementById('overview-grid').innerHTML =
        kpiCards + funnelBlock + insightsBlock + tableBlock + plansBlock;
    }

    // â”€â”€ MEMBERSHIPS TAB â”€â”€
    function renderMemberships() {
      const period = DATA.periods[currentPeriod];
      const global = DATA.globalState;
      const { kpis, subscriptionBreakdown, dailySignups } = period;

      // Summary stats
      const statsHtml = `
        <div class="block full-block">
          <div class="block-header"><div class="block-title">Membership Summary &mdash; ${periodLabel(currentPeriod)}</div></div>
          <div class="stat-row">
            <div class="stat-item">
              <div class="stat-label">Total Active</div>
              <div class="stat-value">${fmtNum(global.totalActive)}</div>
              <div class="stat-sub">${fmtNum(global.monthlySubs)} monthly &bull; ${fmtNum(global.annualSubs)} annual</div>
            </div>
            <div class="stat-item">
              <div class="stat-label">Total MRR</div>
              <div class="stat-value">${fmt$(global.totalMrr)}</div>
              <div class="stat-sub">Across all active plans</div>
            </div>
            <div class="stat-item">
              <div class="stat-label">New Signups</div>
              <div class="stat-value">${fmtNum(kpis.newSignups)}</div>
              ${changeHtml(kpis.signupsChange, false)}
            </div>
            <div class="stat-item">
              <div class="stat-label">Retention Rate</div>
              <div class="stat-value">${fmtPct(kpis.retentionRate)}</div>
              ${changeHtml(kpis.retentionChange, false)}
            </div>
          </div>
        </div>`;

      // Daily signups chart
      const maxSignups = Math.max(...dailySignups.map(d => d.newSubs), 1);
      const skipEvery = dailySignups.length > 20 ? 7 : dailySignups.length > 10 ? 5 : 2;
      const signupBars = dailySignups.map(d => {
        const h = Math.max(2, Math.round((d.newSubs / maxSignups) * 160));
        return `<div class="bar-col bar-signups" style="height: ${h}px;" title="${d.newSubs} signups on ${fmtDay(d.day)}"></div>`;
      }).join('');
      const signupLabels = dailySignups.map((d, i) => {
        const show = i === 0 || i === dailySignups.length - 1 || i % skipEvery === 0;
        return `<div class="bar-label-col"><span class="bar-label${show ? '' : ' bar-label-hidden'}">${fmtDay(d.day)}</span></div>`;
      }).join('');

      const signupChartBlock = `
        <div class="block half-block">
          <div class="block-header">
            <div class="block-title">Daily New Signups</div>
          </div>
          <div class="bar-chart-wrap">
            <div class="bar-chart">${signupBars}</div>
            <div class="bar-chart-labels">${signupLabels}</div>
          </div>
          <div class="chart-legend">
            <span><span class="legend-dot" style="background:var(--accent);display:inline-block;border-radius:2px;"></span>New Signups</span>
          </div>
        </div>`;

      // Status breakdown
      const statusColors = { active: 'status-active', cancelled: 'status-cancelled', pending: 'status-pending', suspended: 'status-suspended' };
      const statusRows = global.allStatuses.map(s => `
        <tr>
          <td><span class="status-pill ${statusColors[s.status] || ''}">${s.status}</span></td>
          <td class="right">${fmtNum(s.count)}</td>
          <td class="right">${fmtPct(s.count / global.allStatuses.reduce((t, x) => t + x.count, 0) * 100)}</td>
        </tr>`).join('');

      const periodBreakdown = `
        <div class="block half-block">
          <div class="block-header"><div class="block-title">Period Activity (${periodLabel(currentPeriod)})</div></div>
          <div class="stat-row">
            <div class="stat-item">
              <div class="stat-label">New Active</div>
              <div class="stat-value" style="color:var(--green);">${fmtNum(subscriptionBreakdown.newActive)}</div>
            </div>
            <div class="stat-item">
              <div class="stat-label">Cancelled</div>
              <div class="stat-value" style="color:var(--red);">${fmtNum(subscriptionBreakdown.newCancelled)}</div>
            </div>
            <div class="stat-item">
              <div class="stat-label">Pending</div>
              <div class="stat-value" style="color:var(--yellow);">${fmtNum(subscriptionBreakdown.newPending)}</div>
            </div>
            <div class="stat-item">
              <div class="stat-label">Suspended</div>
              <div class="stat-value" style="color:var(--text-muted);">${fmtNum(subscriptionBreakdown.newSuspended)}</div>
            </div>
          </div>
          <div class="block-header" style="margin-top:16px;"><div class="block-title">All-Time Status Breakdown</div></div>
          <table class="data-table">
            <thead><tr><th>Status</th><th class="right">Count</th><th class="right">% of Total</th></tr></thead>
            <tbody>${statusRows}</tbody>
          </table>
        </div>`;

      // Plans table (3 columns â€” fits all screen sizes)
      const planRows = global.plans.map(p => {
        const label = p.periodType === 'months' ? fmt$(p.price) + '/mo' : fmt$(p.price) + '/yr';
        const pctOfActive = global.totalActive > 0 ? (p.activeCount / global.totalActive * 100) : 0;
        return `
          <tr>
            <td><span class="source-name">${label}</span><br><small style="color:var(--text-muted);font-size:11px;">${fmtPct(pctOfActive)} of members</small></td>
            <td class="right">${fmtNum(p.activeCount)}</td>
            <td class="right">${fmt$(p.mrr)}</td>
          </tr>`;
      }).join('');

      const plansBlock = `
        <div class="block full-block">
          <div class="block-header"><div class="block-title">Active Plans Breakdown</div></div>
          <table class="data-table">
            <thead><tr><th>Plan</th><th class="right">Members</th><th class="right">Value</th></tr></thead>
            <tbody>
              ${planRows}
              <tr class="summary-row">
                <td><span class="source-name">All Plans</span></td>
                <td class="right">${fmtNum(global.totalActive)}</td>
                <td class="right">${fmt$(global.totalMrr)}</td>
              </tr>
            </tbody>
          </table>
        </div>`;

      document.getElementById('memberships-grid').innerHTML =
        statsHtml + signupChartBlock + periodBreakdown + plansBlock;
    }

    // â”€â”€ ANALYTICS TAB â”€â”€
    function renderAnalytics() {
      const period = DATA.periods[currentPeriod];
      const { kpis, trafficSources, dailySessions } = period;

      // Summary stats
      const statsHtml = `
        <div class="block full-block">
          <div class="block-header"><div class="block-title">Website Analytics &mdash; ${periodLabel(currentPeriod)}</div></div>
          <div class="stat-row">
            <div class="stat-item">
              <div class="stat-label">Total Sessions</div>
              <div class="stat-value">${fmtNum(kpis.websiteSessions)}</div>
              ${changeHtml(kpis.sessionsChange, false)}
            </div>
            <div class="stat-item">
              <div class="stat-label">Avg Daily Sessions</div>
              <div class="stat-value">${dailySessions.length > 0 ? fmtNum(Math.round(kpis.websiteSessions / dailySessions.length)) : '0'}</div>
              <div class="stat-sub">Over ${dailySessions.length} days</div>
            </div>
            <div class="stat-item">
              <div class="stat-label">Conversion Rate</div>
              <div class="stat-value">${fmtPct(kpis.conversionRate)}</div>
              <div class="stat-sub">${fmtNum(kpis.newSignups)} signups from sessions</div>
            </div>
            <div class="stat-item">
              <div class="stat-label">Top Source</div>
              <div class="stat-value" style="font-size:20px;">${trafficSources.length > 0 ? trafficSources.sort((a,b) => b.sessions - a.sessions)[0].source : 'N/A'}</div>
              <div class="stat-sub">${trafficSources.length > 0 ? fmtNum(trafficSources.sort((a,b) => b.sessions - a.sessions)[0].sessions) + ' sessions' : ''}</div>
            </div>
          </div>
        </div>`;

      // Daily sessions chart
      const maxSessions = Math.max(...dailySessions.map(d => d.sessions), 1);
      const skipEveryS = dailySessions.length > 20 ? 7 : dailySessions.length > 10 ? 5 : 2;
      const sessionBars = dailySessions.map(d => {
        const h = Math.max(2, Math.round((d.sessions / maxSessions) * 160));
        return `<div class="bar-col bar-sessions" style="height: ${h}px;" title="${d.sessions} sessions on ${fmtDay(d.day)}"></div>`;
      }).join('');
      const sessionLabels = dailySessions.map((d, i) => {
        const show = i === 0 || i === dailySessions.length - 1 || i % skipEveryS === 0;
        return `<div class="bar-label-col"><span class="bar-label${show ? '' : ' bar-label-hidden'}">${fmtDay(d.day)}</span></div>`;
      }).join('');

      const sessionsChartBlock = `
        <div class="block full-block">
          <div class="block-header">
            <div class="block-title">Daily Sessions</div>
          </div>
          <div class="bar-chart-wrap">
            <div class="bar-chart">${sessionBars}</div>
            <div class="bar-chart-labels">${sessionLabels}</div>
          </div>
          <div class="chart-legend">
            <span><span class="legend-dot" style="background:var(--blue);display:inline-block;border-radius:2px;"></span>Sessions (GA4)</span>
          </div>
        </div>`;

      // Traffic sources detailed table
      const totalSessions = trafficSources.reduce((s, r) => s + r.sessions, 0);
      const sourceRows = trafficSources
        .sort((a, b) => b.sessions - a.sessions)
        .map(row => {
          const pctOfTotal = totalSessions > 0 ? (row.sessions / totalSessions * 100) : 0;
          return `
            <tr>
              <td><span class="source-name">${row.source}</span></td>
              <td class="right">${fmtNum(row.sessions)}</td>
              <td class="right">${fmtPct(pctOfTotal)}</td>
            </tr>`;
        }).join('');

      const sourceTableBlock = `
        <div class="block full-block">
          <div class="block-header"><div class="block-title">Traffic Sources Breakdown</div></div>
          <table class="data-table">
            <thead><tr><th>Source</th><th class="right">Sessions</th><th class="right">Share</th></tr></thead>
            <tbody>
              ${sourceRows}
              <tr class="summary-row">
                <td><span class="source-name">All Sources</span></td>
                <td class="right">${fmtNum(totalSessions)}</td>
                <td><span class="conv-value">100%</span></td>
              </tr>
            </tbody>
          </table>
        </div>`;

      document.getElementById('analytics-grid').innerHTML =
        statsHtml + sessionsChartBlock + sourceTableBlock;
    }

    // â”€â”€ TRIAL ROI TAB â”€â”€
    function generateInsights(roi, totalImpressions, totalClicks) {
      const insights = [];
      const netPerTrial = roi.projectedLtv - roi.costPerTrial;
      const breakEvenMonths = roi.costPerTrial > 0 && roi.conversionRate > 0
        ? (roi.costPerTrial / ((roi.conversionRate / 100) * roi.avgPaidPriceUSD)).toFixed(1) : null;
      const expectedConversions = Math.round(roi.trialsInTrial * roi.conversionRate / 100);
      const incomingLtv = expectedConversions * roi.avgPaidPriceUSD * roi.avgMonthsRetained;
      const clickToTrial = totalClicks > 0 ? (roi.trialsStarted / totalClicks * 100) : 0;

      // 1. ROI status + lever
      if (roi.roiStatus === 'negative' && breakEvenMonths) {
        insights.push({ level: 'warn', icon: 'âš ï¸', title: 'Reduce CPT or extend retention to break even',
          body: `Cost per trial (${fmt$(roi.costPerTrial)}) exceeds projected LTV (${fmt$(roi.projectedLtv)}) by ${fmt$(Math.abs(netPerTrial))}/trial on a ${roi.avgMonthsRetained}-month retention assumption.`,
          action: `Break-even at ${breakEvenMonths} months avg retention. Or reduce CPT below ${fmt$(roi.projectedLtv)} â€” a ${Math.round((1 - roi.projectedLtv / roi.costPerTrial) * 100)}% reduction. Focus: lower CPM through better audience targeting.` });
      } else if (roi.roiStatus === 'positive') {
        insights.push({ level: 'good', icon: 'âœ…', title: `Campaign is ROI positive â€” scale it`,
          body: `Projected LTV (${fmt$(roi.projectedLtv)}) exceeds cost per trial (${fmt$(roi.costPerTrial)}) by ${fmt$(netPerTrial)}/trial.`,
          action: `Each trial generates ${fmt$(netPerTrial)} projected profit. Increase budget on the best-performing campaign to accelerate growth.` });
      } else if (roi.roiStatus === 'neutral') {
        insights.push({ level: 'info', icon: 'ã€œ', title: 'Near break-even â€” small improvements tip it positive',
          body: `Cost per trial (${fmt$(roi.costPerTrial)}) is close to projected LTV (${fmt$(roi.projectedLtv)}).`,
          action: `A 10â€“15% CPT reduction or one additional month of avg retention would make this ROI positive. Prioritise month-2 retention emails.` });
      }

      // 2. Conversion strength
      if (roi.conversionRate >= 50) {
        insights.push({ level: 'good', icon: 'ðŸ†', title: `${roi.conversionRate}% trial conversion â€” world class`,
          body: `Industry benchmark for paid trials is 15â€“20%. Your conversion rate means the product experience and onboarding are working exceptionally well.`,
          action: `Conversion is not the bottleneck. Don't optimise what's working â€” focus energy on reducing cost per trial (CPT) instead.` });
      } else if (roi.conversionRate >= 30) {
        insights.push({ level: 'info', icon: 'ðŸ“ˆ', title: `${roi.conversionRate}% conversion â€” above average`,
          body: `Above industry benchmarks (15â€“20%). Review month-1 onboarding touchpoints to push conversion above 50%.`,
          action: `A targeted "end of trial" email sequence 3â€“5 days before trial expiry is typically the highest-leverage conversion lever.` });
      }

      // 3. Pending pipeline
      if (roi.trialsInTrial > 0) {
        insights.push({ level: 'info', icon: 'â³', title: `${roi.trialsInTrial} trials active â€” ~${expectedConversions} conversions incoming`,
          body: `At ${roi.conversionRate}% historical conversion, expect ~${expectedConversions} of the ${roi.trialsInTrial} active trial members to convert to paid membership.`,
          action: `Projected incoming LTV: ~${fmt$(incomingLtv)} (${expectedConversions} Ã— ${fmt$(roi.avgPaidPriceUSD)}/mo Ã— ${roi.avgMonthsRetained} mo). Send a personalised check-in email before their trial expires.` });
      }

      // 4. Click-to-trial / offer acceptance
      if (roi.offeredCount && roi.offeredCount > 0) {
        const takeRate = (roi.trialsStarted / roi.offeredCount * 100).toFixed(1);
        const improvementTrials = Math.round(roi.offeredCount * 0.25) - roi.trialsStarted;
        insights.push({ level: parseFloat(takeRate) < 20 ? 'warn' : 'good', icon: 'ðŸ“§',
          title: `${takeRate}% of contacts who received the offer signed up`,
          body: `${fmtNum(roi.offeredCount)} contacts were sent the $2 trial offer via email. ${roi.trialsStarted} signed up.`,
          action: improvementTrials > 0
            ? `Improving offer acceptance to 25% would add ~${improvementTrials} more trials at zero additional ad spend. A/B test the email subject line and offer framing.`
            : `Offer acceptance is strong. Maintain the current email sequence.` });
      } else if (clickToTrial > 0) {
        insights.push({ level: clickToTrial >= 1 ? 'good' : 'warn', icon: 'ðŸŽ¯',
          title: `${clickToTrial.toFixed(2)}% of ad clicks start a trial`,
          body: `${fmtNum(totalClicks)} clicks produced ${roi.trialsStarted} trial sign-ups.`,
          action: clickToTrial < 1
            ? `Click-to-trial rate is below 1%. A/B test the trial landing page â€” headline, offer clarity, and friction reduction are highest leverage.`
            : `Landing page is converting well. Focus on improving ad targeting to drive cheaper clicks.` });
      }

      // 5. Dominant campaign
      if (roi.campaigns && roi.campaigns.length > 0 && roi.adSpend > 0) {
        const top = [...roi.campaigns].sort((a, b) => b.spend - a.spend)[0];
        const topPct = Math.round(top.spend / roi.adSpend * 100);
        if (topPct >= 60) {
          const topCtr = top.impressions > 0 ? (top.clicks / top.impressions * 100).toFixed(2) : '0';
          insights.push({ level: 'info', icon: 'ðŸ“Š',
            title: `"${top.name.replace(/^HJR[\s\-â€“|]+/,'')}" is ${topPct}% of spend`,
            body: `${fmt$(top.spend)} of ${fmt$(roi.adSpend)} total. CTR: ${topCtr}% across ${fmtNum(top.impressions)} impressions.`,
            action: `Add UTM parameters to each campaign's trial link so MemberPress can attribute which campaign drives the most sign-ups. Currently attribution is blind.` });
        }
      }

      return insights;
    }

    function renderTrialRoi() {
      const roi = DATA.trialRoi;
      if (!roi) {
        document.getElementById('trial-roi-grid').innerHTML =
          '<div class="loading" style="grid-column:span 12;color:var(--text-muted);">No trial ROI data available. Check config.json trialCampaign settings.</div>';
        return;
      }

      // â”€â”€ Computed values â”€â”€
      const totalImpressions = (roi.campaigns||[]).reduce((s,c) => s+c.impressions, 0);
      const totalClicks      = (roi.campaigns||[]).reduce((s,c) => s+c.clicks, 0);
      const ctr              = totalImpressions > 0 ? (totalClicks/totalImpressions*100) : 0;
      const clickToTrial     = totalClicks > 0 ? (roi.trialsStarted/totalClicks*100) : 0;
      const netPerTrial      = roi.projectedLtv - roi.costPerTrial;
      const totalLtvToDate   = roi.trialsConverted * roi.avgPaidPriceUSD * roi.avgMonthsRetained;
      const expectedConv     = Math.round(roi.trialsInTrial * roi.conversionRate / 100);
      const statusClass      = roi.roiStatus === 'positive' ? 'positive' : roi.roiStatus === 'neutral' ? 'neutral' : 'negative';

      // â”€â”€ 1. STATUS BANNER â”€â”€
      const statusMessages = {
        positive: { icon: 'âœ“', main: `ROI Positive â€” LTV exceeds acquisition cost by ${fmt$(netPerTrial)}/trial`, badge: 'ROI Positive' },
        neutral:  { icon: 'ã€œ', main: `Near Break-even â€” LTV and cost are within 10%`, badge: 'Near Break-even' },
        negative: { icon: '!', main: `ROI Negative â€” cost per trial exceeds LTV by ${fmt$(Math.abs(netPerTrial))}/trial`, badge: 'Below Break-even' },
        unknown:  { icon: '?', main: `Insufficient data â€” configure Facebook Ads API`, badge: 'Unknown' },
      };
      const sm = statusMessages[roi.roiStatus] || statusMessages.unknown;
      const breakEvenMonths = roi.costPerTrial > 0 && roi.conversionRate > 0
        ? (roi.costPerTrial / ((roi.conversionRate/100) * roi.avgPaidPriceUSD)).toFixed(1) : null;
      const bannerDetail = roi.roiStatus === 'negative' && breakEvenMonths
        ? `Break-even requires ~${breakEvenMonths} months avg retention (currently assuming ${roi.avgMonthsRetained}). Revenue from ${roi.trialsConverted} conversions to date: ${fmt$(totalLtvToDate)} projected.`
        : `${roi.trialsConverted} trials converted. Projected LTV earned: ${fmt$(totalLtvToDate)}.`;

      const bannerHtml = `
        <div class="block roi-status-banner ${statusClass}" style="grid-column:span 12">
          <div>
            <div class="roi-status-main">${sm.icon} ${sm.main}</div>
            <div class="roi-status-detail">${bannerDetail}</div>
          </div>
          <span class="roi-badge ${statusClass}" style="white-space:nowrap;flex-shrink:0">${sm.badge}</span>
        </div>`;

      // â”€â”€ 2. FUNNEL PIPELINE â”€â”€
      const funnelSteps = [
        { label: 'Impressions', value: fmtNum(totalImpressions), sub: 'Facebook reach', color: 'var(--blue)', conv: null },
        { label: 'Clicks', value: fmtNum(totalClicks), sub: `${ctr.toFixed(1)}% CTR`, color: 'var(--blue)',
          conv: `${ctr.toFixed(1)}% CTR`, convClass: ctr >= 5 ? 'good' : 'poor' },
        { label: 'Trials Started', value: fmtNum(roi.trialsStarted), sub: `${clickToTrial.toFixed(2)}% of clicks`,
          color: 'var(--accent)', conv: `${clickToTrial.toFixed(2)}% to trial`, convClass: 'neutral' },
        { label: 'Converted', value: fmtNum(roi.trialsConverted), sub: `${roi.conversionRate}% conversion`,
          color: 'var(--green)', conv: `${roi.conversionRate}% converted`, convClass: 'good' },
        { label: 'Projected LTV', value: fmt$(totalLtvToDate), sub: `${roi.trialsConverted} Ã— ${fmt$(roi.avgPaidPriceUSD)} Ã— ${roi.avgMonthsRetained}mo`,
          color: 'var(--green)', conv: null },
      ];

      const offerNote = roi.offeredCount
        ? `<div class="pipeline-offer-note">
            <strong style="color:var(--primary)">${fmtNum(roi.offeredCount)}</strong> email contacts received the $2 trial offer (ActiveCampaign) â†’
            <strong>${roi.trialsStarted}</strong> signed up =
            <strong style="color:var(--accent)">${(roi.trialsStarted/roi.offeredCount*100).toFixed(1)}% offer acceptance rate</strong>
            &mdash; this step sits between Clicks and Trials Started above.
          </div>` : '';

      const funnelHtml = `
        <div class="block full-block">
          <div class="block-header">
            <div class="block-title">Campaign Funnel</div>
            <div style="font-size:12px;color:var(--text-muted)">Facebook Ads â†’ MemberPress since ${roi.campaignStartDate}</div>
          </div>
          <div class="pipeline-stages">
            ${funnelSteps.map((step, i) => `
              <div class="pipeline-step">
                <div class="pipeline-step-label">${step.label}</div>
                <div class="pipeline-step-value" style="color:${step.color}">${step.value}</div>
                <div class="pipeline-step-sub">${step.sub}</div>
                ${step.conv ? `<div class="pipeline-conv ${step.convClass}">${step.conv}</div>` : ''}
              </div>
              ${i < funnelSteps.length - 1 ? '<div class="pipeline-arrow">â†’</div>' : ''}
            `).join('')}
          </div>
          ${offerNote}
        </div>`;

      // â”€â”€ 3. KPI CARDS â”€â”€
      const kpiHtml = `
        <div class="block kpi-card accent" style="grid-column:span 2">
          <div class="kpi-source">Facebook Ads</div>
          <div class="kpi-label">Total Ad Spend</div>
          <div class="kpi-value">${fmt$(roi.adSpend)}</div>
          <div class="kpi-sub">USD since ${roi.campaignStartDate}</div>
        </div>
        <div class="block kpi-card ${roi.costPerTrial > roi.projectedLtv ? 'accent' : 'green'}" style="grid-column:span 2">
          <div class="kpi-source">Calculated</div>
          <div class="kpi-label">Cost Per Trial</div>
          <div class="kpi-value">${fmt$(roi.costPerTrial)}</div>
          <div class="kpi-sub">Target: â‰¤ ${fmt$(roi.projectedLtv)}</div>
        </div>
        <div class="block kpi-card ${roi.conversionRate >= 50 ? 'green' : 'primary'}" style="grid-column:span 2">
          <div class="kpi-source">MemberPress</div>
          <div class="kpi-label">Conversion Rate</div>
          <div class="kpi-value">${fmtPct(roi.conversionRate)}</div>
          <div class="kpi-sub">Trial â†’ Paid (completed trials)</div>
        </div>
        <div class="block kpi-card green" style="grid-column:span 2">
          <div class="kpi-source">Projected</div>
          <div class="kpi-label">LTV per Trial</div>
          <div class="kpi-value">${fmt$(roi.projectedLtv)}</div>
          <div class="kpi-sub">${fmtPct(roi.conversionRate)} Ã— ${fmt$(roi.avgPaidPriceUSD)} Ã— ${roi.avgMonthsRetained}mo</div>
        </div>
        <div class="block kpi-card ${netPerTrial >= 0 ? 'green' : 'accent'}" style="grid-column:span 2">
          <div class="kpi-source">ROI</div>
          <div class="kpi-label">Net per Trial</div>
          <div class="kpi-value" style="color:${netPerTrial >= 0 ? 'var(--green)' : 'var(--red)'}">${netPerTrial >= 0 ? '+' : ''}${fmt$(netPerTrial)}</div>
          <div class="kpi-sub">LTV minus cost per trial</div>
        </div>
        <div class="block kpi-card primary" style="grid-column:span 2">
          <div class="kpi-source">Forecast</div>
          <div class="kpi-label">Pending Conversions</div>
          <div class="kpi-value">${fmtNum(expectedConv)}</div>
          <div class="kpi-sub">${roi.trialsInTrial} in trial Ã— ${roi.conversionRate}% rate</div>
        </div>`;

      // â”€â”€ 4. AI INSIGHTS â”€â”€
      const insights = generateInsights(roi, totalImpressions, totalClicks);
      const insightsHtml = `
        <div class="block full-block">
          <div class="block-header">
            <div class="block-title">AI Insights &amp; Recommendations</div>
            <div style="font-size:12px;color:var(--text-muted)">Auto-generated from live data</div>
          </div>
          <div class="insights-grid">
            ${insights.map(ins => `
              <div class="insight ${ins.level}">
                <div class="insight-title">${ins.icon} ${ins.title}</div>
                <div class="insight-body">${ins.body}</div>
                <div class="insight-action">${ins.action}</div>
              </div>`).join('')}
          </div>
        </div>`;

      // â”€â”€ 5. CAMPAIGN TABLE â”€â”€
      const campaignRows = roi.campaigns && roi.campaigns.length > 0
        ? roi.campaigns.map(c => {
            const ctrC = c.impressions > 0 ? (c.clicks/c.impressions*100).toFixed(2) : '0.00';
            return `<tr>
              <td><span class="source-name">${c.name}</span></td>
              <td class="right">${fmt$(c.spend)}</td>
              <td class="right">${fmtNum(c.impressions)}</td>
              <td class="right">${fmtNum(c.clicks)}</td>
              <td class="right">${ctrC}%</td>
            </tr>`;
          }).join('')
        : '<tr><td colspan="5" style="text-align:center;color:var(--text-muted);padding:24px;">No campaign data. Add FB_ACCESS_TOKEN and FB_AD_ACCOUNT_ID to GitHub Secrets.</td></tr>';

      const totalSpend = (roi.campaigns||[]).reduce((s,c)=>s+c.spend,0);
      const totalImp   = (roi.campaigns||[]).reduce((s,c)=>s+c.impressions,0);
      const totalClk   = (roi.campaigns||[]).reduce((s,c)=>s+c.clicks,0);
      const totalCtr   = totalImp > 0 ? (totalClk/totalImp*100).toFixed(2) : '0.00';

      const campaignBlock = `
        <div class="block full-block">
          <div class="block-header">
            <div class="block-title">Campaign Breakdown (Facebook Ads)</div>
            <div style="font-size:12px;color:var(--text-muted)">Since ${roi.campaignStartDate} &bull; USD</div>
          </div>
          <table class="data-table">
            <thead><tr>
              <th>Campaign</th><th class="right">Spend (USD)</th>
              <th class="right">Impressions</th><th class="right">Clicks</th><th class="right">CTR</th>
            </tr></thead>
            <tbody>
              ${campaignRows}
              ${roi.campaigns && roi.campaigns.length > 0 ? `
              <tr class="summary-row">
                <td><span class="source-name">All Campaigns</span></td>
                <td class="right">${fmt$(totalSpend)}</td>
                <td class="right">${fmtNum(totalImp)}</td>
                <td class="right">${fmtNum(totalClk)}</td>
                <td class="right">${totalCtr}%</td>
              </tr>` : ''}
            </tbody>
          </table>
        </div>`;

      // â”€â”€ 6. COHORT TABLE â”€â”€
      function fmtWeekRange(isoDate) {
        const start = new Date(isoDate + 'T00:00:00');
        const end = new Date(start); end.setDate(end.getDate() + 6);
        const m = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
        return start.getMonth() === end.getMonth()
          ? `${m[start.getMonth()]} ${start.getDate()}â€“${end.getDate()}`
          : `${m[start.getMonth()]} ${start.getDate()} â€“ ${m[end.getMonth()]} ${end.getDate()}`;
      }

      const cohortRows = roi.cohorts.length > 0
        ? roi.cohorts.map(c => {
            const completed = c.converted + c.cancelled;
            const rate = completed > 0 ? Math.round(c.converted / completed * 100) : null;
            const expConv = c.inTrial > 0 ? Math.round(c.inTrial * roi.conversionRate / 100) : null;
            return `<tr>
              <td><span class="cohort-week">${fmtWeekRange(c.week)}</span></td>
              <td class="right">${fmtNum(c.started)}</td>
              <td class="right">${c.converted > 0 ? `<span class="cohort-converted">${fmtNum(c.converted)}</span>` : '<span class="cohort-dash">â€”</span>'}</td>
              <td class="right">${c.cancelled > 0 ? `<span class="cohort-cancelled">${fmtNum(c.cancelled)}</span>` : '<span class="cohort-dash">â€”</span>'}</td>
              <td class="right">${c.inTrial > 0 ? `<span class="cohort-in-trial">${fmtNum(c.inTrial)}</span>` : '<span class="cohort-dash">â€”</span>'}</td>
              <td class="right">${rate !== null ? `<span style="font-weight:600;color:${rate>=50?'var(--green)':rate>=30?'var(--yellow)':'var(--red)'}">${rate}%</span>` : expConv !== null ? `<span style="color:var(--blue);font-size:12px">~${expConv} exp.</span>` : '<span class="cohort-dash">â€”</span>'}</td>
            </tr>`;
          }).join('')
        : '<tr><td colspan="6" style="text-align:center;color:var(--text-muted);padding:24px;">No trial sign-ups found since campaign start date.</td></tr>';

      const cohortBlock = `
        <div class="block full-block">
          <div class="block-header">
            <div class="block-title">Weekly Cohort Table</div>
            <div style="display:flex;gap:16px;font-size:12px;">
              <span style="color:var(--green);font-weight:600;">&#9632; Converted</span>
              <span style="color:var(--red);font-weight:600;">&#9632; Cancelled</span>
              <span style="color:var(--blue);font-weight:600;">&#9632; In Trial</span>
            </div>
          </div>
          <table class="data-table">
            <thead><tr>
              <th>Week</th><th class="right">Started</th>
              <th class="right">Converted</th><th class="right">Cancelled</th>
              <th class="right">In Trial</th><th class="right">Conv Rate</th>
            </tr></thead>
            <tbody>${cohortRows}</tbody>
          </table>
          <div style="margin-top:12px;font-size:12px;color:var(--text-muted);">
            <strong>Converted</strong> = active, trial &gt; 30 days old (presumed retained) &bull;
            <strong>In Trial</strong> = active, &lt; 30 days &bull;
            <strong style="color:var(--blue)">~exp.</strong> = expected conversions at ${roi.conversionRate}% rate
          </div>
        </div>`;

      document.getElementById('trial-roi-grid').innerHTML =
        bannerHtml + funnelHtml + kpiHtml + insightsHtml + campaignBlock + cohortBlock;
    }

    // â”€â”€ RENDER ALL â”€â”€
    function renderAll() {
      if (!DATA) return;

      const updatedDate = new Date(DATA.meta.generatedAt).toLocaleDateString('en-US', {
        month: 'short', day: 'numeric', year: 'numeric'
      });
      document.getElementById('last-updated').textContent = 'Updated: ' + updatedDate;

      renderOverview();
      renderMemberships();
      renderAnalytics();
      renderTrialRoi();
    }

    // â”€â”€ DATE RANGE BUTTONS â”€â”€
    document.getElementById('date-range').addEventListener('click', function(e) {
      const btn = e.target.closest('.date-btn');
      if (!btn) return;
      document.querySelectorAll('.date-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      currentPeriod = btn.dataset.period;
      renderAll();
    });

    // â”€â”€ NAV TABS â”€â”€
    document.getElementById('main-nav').addEventListener('click', function(e) {
      const link = e.target.closest('[data-tab]');
      if (!link) return;
      e.preventDefault();

      document.querySelectorAll('#main-nav a').forEach(a => a.classList.remove('active'));
      link.classList.add('active');

      currentTab = link.dataset.tab;
      document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
      document.getElementById('tab-' + currentTab).classList.add('active');

      const titles = {
        overview: 'Membership & Traffic Overview',
        memberships: 'Membership Details',
        analytics: 'Website Analytics',
        'trial-roi': '$2 Trial â€” Facebook Ads ROI',
      };
      document.getElementById('page-title').innerHTML = titles[currentTab] || '';
    });

    // â”€â”€ LOAD DATA â”€â”€
    fetch('data.json')
      .then(r => { if (!r.ok) throw new Error('data.json not found'); return r.json(); })
      .then(data => {
        DATA = data;
        renderAll();
      })
      .catch(err => {
        document.querySelectorAll('.bento-grid').forEach(grid => {
          grid.innerHTML = `
            <div class="loading" style="grid-column: span 12; color: #dc2626;">
              <strong>Could not load data.json</strong><br><br>
              Run <code>node fetch-data.js</code> to fetch live data from BigQuery.<br><br>
              <small style="color: #6b7280;">${err.message}</small>
            </div>`;
        });
      });
  </script>
</body>
</html>
